<!--index.wxml-->
<custom-nav></custom-nav>
<view class="container-full {{(isMember || ischeck) ? 'vip-page' : 'nonvip-page'}}">
  <!-- 适应导航栏高度的顶部空间 -->
  <view style="height: {{navHeight}}px;"></view>
  <view class="flex flex-col h-full pb-16"> <!-- 底部留出导航栏高度 -->
    <!-- 顶部欢迎区域 -->
    <view class="header-gradient px-3 pt-2 pb-8 rounded-b-3xl w-full"> <!-- 保持w-full确保宽度100% -->
      <view class="flex items-center justify-between mb-4">
        <view class="flex items-center flex-1">
          <image class="icon-img mr-2" src="/images/icons/graduation.png" mode="aspectFit"></image>
          <text class="text-lg font-bold text-white truncate">昆明市中考助手</text>
        </view>
      </view>
      
      <view>
        <text class="text-white opacity-80 font-sm mb-1 block">您好，同学</text>
        <view class="text-xl font-bold text-white">今天距离中考还剩 <text class="text-warning">{{remainingDays}}</text> 天</view>
      </view>
    </view>

    <!-- 内容区域 - 主要内容的容器 -->
    <view class="flex-1 px-3 -mt-5 pb-4">
      <!-- 梦想启航模块 - 展示用户目标和进度 -->
      <view class="card p-3 mb-3">
        <!-- 标题栏 - 包含标题和设置按钮 -->
        <view class="flex justify-between items-center mb-3">
          <!-- 左侧标题区域 -->
          <view class="font-bold">
            <!-- 火箭图标 -->
            <image class="icon-img mr-2 text-primary" src="/images/icons/rocket.png" mode="aspectFit"></image>
            <!-- 模块标题文字 -->
            <text>梦想启航</text>
          </view>
          <!-- 右侧设置按钮 -->
          <view class="text-primary font-sm text-right" bindtap="setTarget">
            <!-- 设置按钮文字 -->
            <text>重新输入</text>
          </view>
        </view>

        <view class="bg-light rounded-lg p-2 mb-3">
          <view class="flex justify-between mb-1">
            <text class="font-sm text-secondary">上次模考成绩</text>
            <view class="flex items-center">
              <!-- 如果有用户成绩就显示成绩，没有就显示输入按钮 -->
              <text wx:if="{{userScore}}" class="text-primary font-medium">{{userScore}}</text>
              <view wx:else class="text-primary font-xs py-1 px-2 border border-primary rounded-lg" bindtap="setUserScoreButton">输入成绩</view>
            </view>
          </view>
          <view class="flex justify-between mb-1">
            <text class="font-sm text-secondary">目标院校</text>
            <view class="flex items-center">
              <!-- 如果有目标学校就显示学校名，没有就显示输入按钮 -->
              <text wx:if="{{targetSchool}}" class="text-primary font-medium">{{targetSchool}}</text>
              <view wx:else class="text-primary font-xs py-1 px-2 border border-primary rounded-lg" bindtap="setTargetSchoolButton">输入目标学校</view>
            </view>
          </view>
          <view wx:if="{{targetSchool && targetSchoolScore}}" class="flex justify-between mb-3 {{!isMember && !ischeck ? 'relative' : ''}}">
            <text class="font-sm text-secondary">目标分数</text>
            <block wx:if="{{isMember || ischeck}}">
              <text class="text-primary font-medium">{{targetSchoolScore}}分</text>
            </block>
            <block wx:else>
              <!-- 非会员遮盖目标分数 -->
              <view class="vip-mask">
                <text class="text-primary font-medium">距离目标院校还差***分</text> 
              </view>
            </block>
          </view>
          <!-- 分数差距只在会员显示 -->
          <block wx:if="{{isMember || ischeck}}">
            <view wx:if="{{userScore && targetSchool && scoreDifference !== null && scoreDifference > 0}}" class="flex justify-center mt-2 mb-2">
              <text class="text-primary font-medium">距离目标院校还差 {{scoreDifference}} 分，加油哦～</text>
            </view>
            <view wx:elif="{{userScore && targetSchool && scoreDifference === 0}}" class="flex justify-center mt-2 mb-2">
              <text class="text-success font-medium">已达到目标分数，恭喜你～</text>
            </view>
          </block>
          <!-- 非会员不显示分数差距 -->
        </view>
        
        <!-- 可匹配院校 -->
        <view class="{{!isMember && !ischeck ? 'relative' : ''}}">
          <view class="flex justify-between items-center mb-2">
            <text class="font-medium">可匹配院校：</text>
            <view class="text-primary font-sm text-right" bindtap="{{(isMember || ischeck) ? 'gotoMatchedSchools' : 'showVipModal'}}">
              <text>{{(isMember || ischeck) ? '查看完整匹配院校清单' : '查看完整匹配院校清单'}}</text>
            </view>
          </view>
          
          <!-- 会员状态下显示全部学校 -->
          <block wx:if="{{isMember || ischeck}}">
            <view class="space-y-2">
              <view wx:for="{{matchedSchools}}" wx:key="rank" class="flex justify-between items-center p-2 bg-gray rounded-lg">
                <view class="flex-1">
                  <view class="flex items-center justify-between">
                    <text class="font-medium">{{item.schoolName}}</text>
                    <text class="font-xs {{item.reachable ? 'text-success' : 'text-danger'}}">
                      {{item.reachable ? '符合要求' : '不符合要求'}}
                    </text>
                  </view>
                  <text class="font-xs text-gray">2024年：{{item.score}}分</text>
                </view>
              </view>
              
              <view wx:if="{{matchedSchools.length === 0}}" class="text-center p-3">
                <text class="text-gray">暂无匹配学校，请设置您的成绩</text>
              </view>
            </view>
          </block>
          
          <!-- 非会员状态下只显示第一所学校 -->
          <block wx:else>
            <view class="space-y-2">
              <!-- 显示第一所学校 -->
              <view wx:for="{{matchedSchools}}" wx:key="rank" wx:if="{{index === 0}}" class="flex justify-between items-center p-2 bg-gray rounded-lg">
                <view class="flex-1">
                  <view class="flex items-center justify-between">
                    <text class="font-medium">{{item.schoolName}}</text>
                    <text class="font-xs {{item.reachable ? 'text-success' : 'text-danger'}}">
                      {{item.reachable ? '符合要求' : '不符合要求'}}
                    </text>
                  </view>
                  <text class="font-xs text-gray">2024年：{{item.score}}分</text>
                </view>
              </view>
              
              <!-- 其余学校放在遮罩层下面 -->
              <view class="remaining-schools relative" wx:if="{{matchedSchools.length > 1}}">
                <!-- 显示第二所及以后的学校，但会被遮罩 -->
                <view wx:for="{{matchedSchools}}" wx:key="rank" wx:if="{{index > 0}}" class="flex justify-between items-center p-2 bg-gray rounded-lg">
                  <view class="flex-1">
                    <view class="flex items-center justify-between">
                      <text class="font-medium">{{item.schoolName}}</text>
                      <text class="font-xs {{item.reachable ? 'text-success' : 'text-danger'}}">
                        {{item.reachable ? '符合要求' : '不符合要求'}}
                      </text>
                    </view>
                    <text class="font-xs text-gray">2024年：{{item.score}}分</text>
                  </view>
                </view>
                
                <!-- 遮盖层只遮盖第二所及以后的学校 -->
                <view class="vip-mask partial-mask" bindtap="goToVip">
                  <view class="vip-mask-content">
                    <text class="vip-mask-text">开通会员可查看完整内容</text>
                    <button class="vip-btn">立即开通</button>
                  </view>
                </view>
              </view>
              
              <view wx:if="{{matchedSchools.length === 0}}" class="text-center p-3">
                <text class="text-gray">暂无匹配学校，请设置您的成绩</text>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 快捷入口 -->
      <view class="mb-3">
        <view class="font-bold mb-3">快捷入口</view>
        <view class="grid grid-cols-2 gap-2">
          <view wx:for="{{quickLinks}}" wx:key="id" class="card p-2 flex flex-col items-center" bindtap="gotoQuickLink" data-link="{{item}}">
            <view class="w-12 h-12 rounded-full bg-light flex items-center justify-center mb-2">
              <image class="icon-img" src="{{item.icon}}" mode="aspectFit"></image>
            </view>
            <text class="font-medium">{{item.name}}</text>
          </view>
        </view>
      </view>

      <!-- 中考时间线 -->
      <view class="card p-3 mb-3">
        <view class="flex justify-between items-center mb-3">
          <view class="font-bold">
            <image class="icon-img mr-2 text-secondary" src="/images/icons/calendar.png" mode="aspectFit"></image>
            <text>中考时间线</text>
          </view>
          <view class="text-primary font-sm" bindtap="showFullTimelineModal">
            <text>点击查看完整时间线</text>
          </view>
        </view>

        <view class="relative pb-2">
          <view class="absolute left-4 top-0 bottom-0 w-05 bg-gray"></view>
          
          <!-- 会员显示多条 -->
          <block wx:if="{{isMember || ischeck}}">
            <view wx:for="{{upcomingTimeline}}" wx:key="originalTime" 
                  class="{{item.isActive ? 'time-line-item active bg-primary' : 'time-line-item relative flex items-center mb-4 rounded-lg p-3 pl-10 bg-gray'}}">
              <view class="absolute left-3 w-6 h-6 {{item.isActive ? 'bg-primary' : 'bg-white'}} rounded-full border-2 {{item.isActive ? 'border-blue-100' : 'border-gray'}} flex items-center justify-center">
                <view class="w-2 h-2 {{item.isActive ? 'bg-white' : 'bg-gray'}} rounded-full"></view>
              </view>
              <view class="flex-1">
                <view class="font-medium">{{item.title}}</view>
                <view class="font-xs {{item.isActive ? 'opacity-80' : 'text-gray'}}">{{item.date}}</view>
              </view>
              <view class="{{item.isActive ? 'font-medium' : 'text-gray font-sm'}}">
                {{item.countdown}}
              </view>
            </view>
          </block>
          <!-- 非会员只显示一条，其余遮盖 -->
          <block wx:else>
            <view wx:for="{{upcomingTimeline}}" wx:key="originalTime" wx:index="idx" 
                  wx:if="{{index < 1}}" 
                  class="{{item.isActive ? 'time-line-item active bg-primary' : 'time-line-item relative flex items-center mb-4 rounded-lg p-3 pl-10 bg-gray'}}">
              <view class="absolute left-3 w-6 h-6 {{item.isActive ? 'bg-primary' : 'bg-white'}} rounded-full border-2 {{item.isActive ? 'border-blue-100' : 'border-gray'}} flex items-center justify-center">
                <view class="w-2 h-2 {{item.isActive ? 'bg-white' : 'bg-gray'}} rounded-full"></view>
              </view>
              <view class="flex-1">
                <view class="font-medium">{{item.title}}</view>
                <view class="font-xs {{item.isActive ? 'opacity-80' : 'text-gray'}}">{{item.date}}</view>
              </view>
              <view class="{{item.isActive ? 'font-medium' : 'text-gray font-sm'}}">
                {{item.countdown}}
              </view>
            </view>
            <!-- 遮盖层 -->
            <view class="timeline-remaining relative">
              <!-- 放一个占位元素，保证遮罩高度 -->
              <view wx:if="{{fullTimelineData.length > 1}}" 
                    class="time-line-item relative flex items-center mb-4 rounded-lg p-3 pl-10 bg-gray opacity-0">
                 <view class="absolute left-3 w-6 h-6 bg-white rounded-full border-2 border-gray flex items-center justify-center"><view class="w-2 h-2 bg-gray rounded-full"></view></view> <view class="flex-1"><view class="font-medium">占位</view><view class="font-xs text-gray">占位</view></view><view class="text-gray font-sm">占位</view>
              </view>
              <view class="vip-mask full-mask" bindtap="goToVip">
                <view class="vip-mask-content">
                  <text class="vip-mask-text">开通会员可查看完整内容</text>
                  <button class="vip-btn">立即开通</button>
                </view>
              </view>
            </view>
          </block>
          
          <view wx:if="{{!upcomingTimeline || upcomingTimeline.length === 0}}" class="text-center p-3">
            <text class="text-gray">暂无即将到来的事件</text>
          </view>
        </view>
        
        <!-- 移除测试按钮 -->
        <!-- <view class="flex justify-center mt-3">
          <button class="test-btn" bindtap="goToNonVipIndex">测试</button>
        </view> -->
      </view>
    </view>
  </view>
</view>

<!-- 学校搜索模态框 -->
<view class="search-modal {{showSchoolSearch ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="search-modal-content">
    <view class="search-modal-header">
      <text class="search-modal-title">选择目标学校</text>
      <view class="search-modal-close" bindtap="closeSchoolSearch">×</view>
    </view>
    <view class="search-input-wrapper">
      <view class="input-container">
        <input class="search-input" placeholder="输入学校名称" bindinput="onSchoolSearchInput" value="{{searchKeyword}}" focus="{{showSchoolSearch}}" confirm-type="search" adjust-position="true"/>
        <view class="search-clear-button" wx:if="{{searchKeyword}}" bindtap="clearSchoolSearch">×</view>
      </view>
    </view>
    <scroll-view scroll-y class="search-results" wx:if="{{schoolSearchList.length > 0}}">
      <view wx:for="{{schoolSearchList}}" wx:key="index" class="search-result-item" bindtap="selectSchoolFromSearch" data-index="{{index}}">
        <view class="search-result-school">{{item.schoolName}}</view>
        <view class="search-result-score">{{item.score}}分</view>
      </view>
    </scroll-view>
    <view wx:if="{{schoolSearchList.length === 0 && searchKeyword}}" class="search-no-result">
      <text>未找到相关学校</text>
    </view>
  </view>
</view>

<!-- 搜索遮罩层 -->
<view class="search-mask {{showSchoolSearch ? 'show' : ''}}" bindtap="closeSchoolSearch"></view>

<!-- 成绩输入模态框 -->
<view class="search-modal {{showScoreInput ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="search-modal-content">
    <view class="search-modal-header">
      <text class="search-modal-title">设置模考成绩</text>
      <view class="search-modal-close" bindtap="closeScoreInput">×</view>
    </view>
    <view class="search-input-wrapper">
      <view class="input-container">
        <input class="search-input" type="digit" placeholder="输入成绩分数" bindinput="onScoreInput" value="{{scoreInput}}" focus="{{showScoreInput}}" confirm-type="done"/>
        <view class="search-clear-button" wx:if="{{scoreInput}}" bindtap="clearScoreInput">×</view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-btn" bindtap="closeScoreInput">取消</button>
      <button class="modal-btn confirm-btn" bindtap="confirmScoreInput">确定</button>
    </view>
  </view>
</view>

<!-- 成绩输入遮罩层 -->
<view class="search-mask {{showScoreInput ? 'show' : ''}}" bindtap="closeScoreInput"></view>

<!-- 完整时间线模态框 -->
<view class="search-modal {{showTimelineModal ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="search-modal-content full-timeline-modal">
    <view class="search-modal-header">
      <text class="search-modal-title">完整中考时间线</text>
      <view class="search-modal-close" bindtap="closeFullTimelineModal">×</view>
    </view>
    <scroll-view scroll-y class="search-results full-timeline-results" scroll-with-animation="true" enhanced="true" show-scrollbar="true">
      <view wx:for="{{fullTimelineData}}" wx:key="originalTime" 
            class="timeline-modal-item {{item.isActive ? 'active' : ''}}">
        <view class="timeline-modal-date">{{item.date}}</view>
        <view class="timeline-modal-content">
          <view class="timeline-modal-title">{{item.title}}</view>
          <view class="timeline-modal-event">{{item.event}}</view> 
        </view>
        <view class="timeline-modal-countdown {{item.isActive ? 'active' : ''}}">{{item.countdown}}</view>
      </view>
      <view wx:if="{{!fullTimelineData || fullTimelineData.length === 0}}" class="search-no-result">
          <text>暂无时间线数据</text>
      </view>
    </scroll-view>
  </view>
</view>

<!-- 时间线模态框遮罩层 -->
<view class="search-mask {{showTimelineModal ? 'show' : ''}}" bindtap="closeFullTimelineModal"></view>

<!-- VIP提示模态框 -->
<view class="search-modal {{showVipModal ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="search-modal-content">
    <view class="search-modal-header">
      <text class="search-modal-title">开通会员提示</text>
      <view class="search-modal-close" bindtap="hideVipModal">×</view>
    </view>
    <view class="vip-modal-content">
      <view class="vip-modal-icon">
        <!-- 删除了vip.png图标引用 -->
      </view>
      <view class="vip-modal-text">
        <text class="vip-modal-title">开通会员，即可查看完整内容</text>
        <text class="vip-modal-desc">包括目标分数、分数差距、匹配院校等全部功能</text>
      </view>
      <button class="vip-btn-large" bindtap="goToVip">立即开通会员</button>
    </view>
  </view>
</view>
<view class="search-mask {{showVipModal ? 'show' : ''}}" bindtap="hideVipModal"></view>

<!-- 在文件最底部添加自定义TabBar组件引用 -->
<custom-tab-bar id="custom-tab-bar"></custom-tab-bar>